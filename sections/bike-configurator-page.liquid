{{ 'section-bike-configurator.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

<script src="{{ 'bike-configurator.js' | asset_url }}" defer="defer"></script>

{%- liquid
  if section.settings.product_handle != blank
    assign configurator_product = all_products[section.settings.product_handle]
  else
    assign configurator_product = null
  endif

  if configurator_product == null and request.design_mode
    assign configurator_product = products.first
  endif
-%}

{%- if configurator_product -%}
  <section class="bike-configurator-page">
    <div class="page-width">
      
      <header class="configurator-header">
        <h1 class="configurator-title">{{ section.settings.heading }}</h1>
        <p class="configurator-subtitle">{{ section.settings.subheading }}</p>
      </header>

      <div class="configurator-container">
        
        <!-- Product Media using Shopify's native system -->
        <div class="configurator-media">
          {% render 'product-media-gallery', product: configurator_product %}
          
          <div class="configurator-badges">
            <div class="badge">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M12 2L3 7L12 12L21 7L12 2Z" stroke="currentColor" stroke-width="2"/>
                <path d="M3 17L12 22L21 17" stroke="currentColor" stroke-width="2"/>
                <path d="M3 12L12 17L21 12" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>200+ Service-Standorte</span>
            </div>
            <div class="badge">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>14 Tage Rücknahmegarantie</span>
            </div>
            <div class="badge">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>2 Jahre Garantie</span>
            </div>
          </div>
        </div>

        <!-- Configuration Panel -->
        <div class="configurator-panel">
          
          <!-- Product Title -->
          <div class="configurator-product-title">
            <h2>{{ configurator_product.title }}</h2>
          </div>

          <!-- Price Display -->
          <div class="configurator-pricing">
            <div class="price-display" id="price-{{ section.id }}">
              {% render 'price', product: configurator_product, use_variant: true, show_badges: true %}
            </div>
            <div class="shipping-info">
              <span>Versand</span>
              <span>Beim Checkout berechnet</span>
            </div>
          </div>

          <!-- Variant Selection using Shopify's native system -->
          <div class="configurator-variants">
            <variant-radios
              id="variant-radios-{{ section.id }}"
              class="no-js-hidden"
              data-section="{{ section.id }}"
              data-url="{{ configurator_product.url }}"
              data-update-url="false"
            >
              {%- for option in configurator_product.options_with_values -%}
                <div class="variant-option-group">
                  <h3 class="option-title">
                    {{ option.name }}
                    {%- if option.name contains 'Color' or option.name contains 'Farbe' -%}
                      <span class="selected-value" data-selected-color>{{ option.selected_value | default: option.values.first }}</span>
                    {%- endif -%}
                  </h3>
                  
                  <fieldset class="js product-form__input">
                    <legend class="form__label">{{ option.name }}</legend>
                    
                    {%- if option.name contains 'Color' or option.name contains 'Farbe' -%}
                      <div class="color-options">
                        {%- for value in option.values -%}
                          <input
                            type="radio"
                            id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            name="{{ option.name }}"
                            value="{{ value | escape }}"
                            form="{{ product_form_id }}"
                            {% if option.selected_value == value %}checked{% endif %}
                          >
                          <label 
                            for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            class="color-swatch-label"
                            title="{{ value }}"
                          >
                            <div class="color-swatch color-swatch--{{ value | handleize }}"
                                 style="background-color: {% if value contains 'Black' or value contains 'Schwarz' %}#000{% elsif value contains 'Sand' %}#D4C5A0{% elsif value contains 'White' or value contains 'Weiß' %}#fff{% elsif value contains 'Red' or value contains 'Rot' %}#dc2626{% elsif value contains 'Blue' or value contains 'Blau' %}#2563eb{% elsif value contains 'Green' or value contains 'Grün' %}#16a34a{% else %}#6b7280{% endif %}">
                            </div>
                            <svg class="color-check" width="16" height="16" viewBox="0 0 16 16" fill="none">
                              <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2"/>
                            </svg>
                          </label>
                        {%- endfor -%}
                      </div>
                      
                    {%- elsif option.name contains 'Size' or option.name contains 'Größe' -%}
                      <div class="size-options">
                        {%- for value in option.values -%}
                          <input
                            type="radio"
                            id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            name="{{ option.name }}"
                            value="{{ value | escape }}"
                            form="{{ product_form_id }}"
                            {% if option.selected_value == value %}checked{% endif %}
                          >
                          <label 
                            for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            class="size-option-label"
                          >
                            {{ value }}
                          </label>
                        {%- endfor -%}
                      </div>
                      
                    {%- else -%}
                      <div class="default-options">
                        {%- for value in option.values -%}
                          <input
                            type="radio"
                            id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            name="{{ option.name }}"
                            value="{{ value | escape }}"
                            form="{{ product_form_id }}"
                            {% if option.selected_value == value %}checked{% endif %}
                          >
                          <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}">
                            {{ value }}
                          </label>
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  </fieldset>
                </div>
              {%- endfor -%}
              
              <script type="application/json">
                {{ configurator_product.variants | json }}
              </script>
            </variant-radios>
          </div>

          <!-- Add to Cart Form -->
          <div class="configurator-actions">
            {%- assign product_form_id = 'product-form-' | append: section.id -%}
            <product-form class="product-form" data-hide-errors="{{ section.settings.hide_variants }}" data-section-id="{{ section.id }}">
              {%- form 'product', configurator_product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" value="{{ configurator_product.selected_or_first_available_variant.id }}" class="product-variant-id">
                
                <div class="product-form__buttons">
                  <button
                    type="submit"
                    name="add"
                    class="btn product-form__cart-submit btn--primary btn--full-width"
                    {% if configurator_product.selected_or_first_available_variant.available == false %}disabled{% endif %}
                  >
                    <span>
                      {%- if configurator_product.selected_or_first_available_variant.available -%}
                        In den Einkaufswagen
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </span>
                    <div class="loading__spinner hidden">
                      {% render 'icon-spinner' %}
                    </div>
                  </button>
                </div>
              {%- endform -%}
            </product-form>
          </div>

          <!-- Delivery Info -->
          <div class="configurator-delivery">
            <div class="delivery-info">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <rect x="2" y="3" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                <path d="M8 3V1M12 3V1M2 7H18" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              <div>
                <span class="delivery-label">Voraussichtliche Lieferung</span>
                <span class="delivery-date">August 2025</span>
              </div>
            </div>
            <p class="payment-info">
              Bezahle in 3 zinsfreien Teilzahlungen. Mit Käuferschutz* von Klarna
            </p>
          </div>

        </div>
      </div>
    </div>
  </section>

{%- else -%}
  <section class="bike-configurator-page">
    <div class="page-width">
      <div class="configurator-error">
        <h2>Product not found</h2>
        <p>Please select a valid product handle in the theme settings.</p>
      </div>
    </div>
  </section>
{%- endif -%}

{% schema %}
{
  "name": "Bike Configurator Page",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "product_handle",
      "label": "Product handle",
      "info": "Enter the handle of the product to configure"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Configure Your Bike"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Customize your bike to your exact specifications"
    }
  ],
  "presets": [
    {
      "name": "Bike Configurator Page"
    }
  ]
}
{% endschema %} 