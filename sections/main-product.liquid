<section
  id="MainProduct-{{ section.id }}"
  class="section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}"
  data-section="{{ section.id }}"
>
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
  {{ 'component-accordion.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'component-slider.css' | asset_url | stylesheet_tag }}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}
  {% if product.quantity_price_breaks_configured? %}
    {{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}
  {% endif %}

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }
  {%- endstyle -%}

  <script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
  {% if product.quantity_price_breaks_configured? %}
    <script src="{{ 'show-more.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'price-per-item.js' | asset_url }}" defer="defer"></script>
  {% endif %}

  {% if section.settings.image_zoom == 'hover' %}
    <script id="EnableZoomOnHover-main" src="{{ 'magnify.js' | asset_url }}" defer="defer"></script>
  {% endif %}
  {% if request.design_mode %}
    <script src="{{ 'theme-editor.js' | asset_url }}" defer="defer"></script>
  {% endif %}

  {% assign first_3d_model = product.media | where: 'media_type', 'model' | first %}
  {% if first_3d_model %}
    {{ 'component-product-model.css' | asset_url | stylesheet_tag }}
    <link
      id="ModelViewerStyle"
      rel="stylesheet"
      href="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer-ui.css"
      media="print"
      onload="this.media='all'"
    >
    <link
      id="ModelViewerOverride"
      rel="stylesheet"
      href="{{ 'component-model-viewer-ui.css' | asset_url }}"
      media="print"
      onload="this.media='all'"
    >
  {% endif %}

  {% assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src' %}

  <div class="page-width">
    <div class="product product--{{ section.settings.media_size }} product--{{ section.settings.media_position }} product--{{ section.settings.gallery_layout }} product--mobile-{{ section.settings.mobile_thumbnails }} grid grid--1-col {% if product.media.size > 0 %}grid--2-col-tablet{% else %}product--no-media{% endif %}">
      <div class="grid__item product__media-wrapper{% if section.settings.media_position == 'right' %} medium-hide large-up-hide{% endif %}">
        {% render 'product-media-gallery', variant_images: variant_images %}
      </div>

      <div class="product__info-wrapper grid__item{% if settings.page_width > 1400 and section.settings.media_size == "small" %} product__info-wrapper--extra-padding{% endif %}">
        <product-info
          id="ProductInfo-{{ section.id }}"
          data-section="{{ section.id }}"
          data-url="{{ product.url }}"
          class="product__info-container{% if section.settings.enable_sticky_info %} product__column-sticky{% endif %}"
        >
          {% assign product_form_id = 'product-form-' | append: section.id %}

          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {% when '@app' %}
                {% render block %}

              {% when 'text' %}
                <p
                  class="product__text inline-richtext{% if block.settings.text_style == 'uppercase' %} caption-with-letter-spacing{% elsif block.settings.text_style == 'subtitle' %} subtitle{% endif %}"
                  {{ block.shopify_attributes }}
                >
                  {{- block.settings.text -}}
                </p>

              {% when 'title' %}
                <div class="product__title" {{ block.shopify_attributes }}>
                  <h1>{{ product.title | escape }}</h1>
                  <a href="{{ product.url }}" class="product__title">
                    <h2 class="h1">
                      {{ product.title | escape }}
                    </h2>
                  </a>
                </div>

              {% when 'price' %}
                <div class="no-js-hidden" id="price-{{ section.id }}" role="status" {{ block.shopify_attributes }}>
                  {%- render 'price',
                    product: product,
                    use_variant: true,
                    show_badges: true,
                    price_class: 'price--large'
                  -%}
                </div>
                {% if product.quantity_price_breaks_configured? %}
                  <div class="volume-pricing-note" id="Volume-Note-{{ section.id }}">
                    <span>{{ 'products.product.volume_pricing.note' | t }}</span>
                  </div>
                {% endif %}
                <div class="product__tax caption rte">
                  {% if cart.taxes_included %}
                    {{ 'products.product.include_taxes' | t }}
                  {% endif %}
                  {% if shop.shipping_policy.body != blank %}
                    {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                  {% endif %}
                </div>
                <div {{ block.shopify_attributes }}>
                  {% assign product_form_installment_id = 'product-form-installment-' | append: section.id %}
                  {% form 'product', product, id: product_form_installment_id, class: 'installment caption-large' %}
                    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                    {{ form | payment_terms }}
                  {% endform %}
                </div>

              {% when 'sku' %}
                <p
                  class="product__sku no-js-hidden{% if block.settings.text_style == 'uppercase' %} caption-with-letter-spacing{% elsif block.settings.text_style == 'subtitle' %} subtitle{% endif %}{% if product.selected_or_first_available_variant.sku.size == 0 %} visibility-hidden{% endif %}"
                  id="Sku-{{ section.id }}"
                  role="status"
                  {{ block.shopify_attributes }}
                >
                  <span class="visually-hidden">{{ 'products.product.sku' | t }}:</span> {{- product.selected_or_first_available_variant.sku -}}
                </p>

              {% when 'inventory' %}
                {# Inventory code... #}
                <!-- Keep your original inventory code here -->

              {% when 'quantity_selector' %}
                {# Quantity selector code... #}
                <!-- Keep your quantity selector code here -->

              {% when 'variant_picker' %}
                {# Variant picker code... #}
                <!-- Keep your variant picker code here -->

              {% when 'buy_buttons' %}
                {%- render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true -%}

              {% when 'description' %}
                {% if product.description != blank %}
                  <div class="product__description rte" {{ block.shopify_attributes }}>
                    {{ product.description }}
                  </div>
                {% endif %}

              {% when 'share' %}
                {# Share code #}

              {% when 'custom_liquid' %}
                {{ block.settings.custom_liquid }}

              {% when 'collapsible_tab' %}
                {# Collapsible tab code #}

              {% when 'popup' %}
                {# Popup code #}

              {% when 'rating' %}
                {# Rating code #}

              {% when 'complementary' %}
                {# Complementary products code #}

              {% when 'icon-with-text' %}
                {# Icon-with-text code #}

            {%- endcase -%}
          {%- endfor -%}

          <a href="{{ product.url }}" class="link product__view-details animate-arrow">
            {{ 'products.product.view_full_details' | t }}
            {% render 'icon-arrow' %}
          </a>
        </product-info>
      </div>

      {% if section.settings.media_position == 'right' %}
        <!-- Duplicate gallery for desktop if media is on right -->
        <div class="grid__item product__media-wrapper small-hide">
          {% render 'product-media-gallery', variant_images: variant_images, is_duplicate: true %}
        </div>
      {% endif %}
    </div>

    {% render 'product-media-modal', variant_images: variant_images %}

    {% assign popups = section.blocks | where: 'type', 'popup' %}
    {% for block in popups %}
      <modal-dialog id="PopupModal-{{ block.id }}" class="product-popup-modal" {{ block.shopify_attributes }}>
        <div
          role="dialog"
          aria-label="{{ block.settings.text }}"
          aria-modal="true"
          class="product-popup-modal__content"
          tabindex="-1"
        >
          <button
            id="ModalClose-{{ block.id }}"
            type="button"
            class="product-popup-modal__toggle"
            aria-label="{{ 'accessibility.close' | t }}"
          >
            {% render 'icon-close' %}
          </button>
          <div class="product-popup-modal__content-info">
            <h1 class="h2">{{ block.settings.page.title }}</h1>
            {{ block.settings.page.content }}
          </div>
        </div>
      </modal-dialog>
    {% endfor %}

    {% if product.media.size > 0 %}
      <script src="{{ 'product-modal.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'media-gallery.js' | asset_url }}" defer="defer"></script>
    {% endif %}

    {% if first_3d_model %}
      <script type="application/json" id="ProductJSON-{{ product.id }}">
        {{ product.media | where: 'media_type', 'model' | json }}
      </script>
      <script src="{{ 'product-model.js' | asset_url }}" defer></script>
    {% endif %}

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        function isIE() {
          var ua = window.navigator.userAgent;
          var msie = ua.indexOf('MSIE ');
          var trident = ua.indexOf('Trident/');
          return msie > 0 || trident > 0;
        }
        if (!isIE()) return;

        var hiddenInput = document.querySelector('#{{ product_form_id }} input[name="id"]');
        var noScriptInputWrapper = document.createElement('div');
        var variantSwitcher =
          document.querySelector('variant-radios[data-section="{{ section.id }}"]') ||
          document.querySelector('variant-selects[data-section="{{ section.id }}"]');

        noScriptInputWrapper.innerHTML = document.querySelector(
          '.product-form__noscript-wrapper-{{ section.id }}'
        ).textContent;

        variantSwitcher.outerHTML = noScriptInputWrapper.outerHTML;

        document.querySelector('#Variants-{{ section.id }}').addEventListener('change', function (event) {
          hiddenInput.value = event.currentTarget.value;
        });
      });
    </script>

    {% liquid
      if product.selected_or_first_available_variant.featured_media
        assign seo_media = product.selected_or_first_available_variant.featured_media
      else
        assign seo_media = product.featured_media
      endif
    %}

    <script type="application/ld+json">
      {
        "@context": "http://schema.org/",
        "@type": "Product",
        "name": {{ product.title | json }},
        "url": {{ request.origin | append: product.url | json }},
        {% if seo_media %}
          "image": [
            {{ seo_media | image_url: width: 1920 | prepend: "https:" | json }}
          ],
        {% endif %}
        "description": {{ product.description | strip_html | json }},
        {% if product.selected_or_first_available_variant.sku != blank %}
          "sku": {{ product.selected_or_first_available_variant.sku | json }},
        {% endif %}
        "brand": {
          "@type": "Brand",
          "name": {{ product.vendor | json }}
        },
        "offers": [
          {% for variant in product.variants %}
            {
              "@type" : "Offer",
              {% if variant.sku != blank %}
                "sku": {{ variant.sku | json }},
              {% endif %}
              "availability" : "http://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
              "price" : {{ variant.price | divided_by: 100.00 | json }},
              "priceCurrency" : {{ cart.currency.iso_code | json }},
              "url" : {{ request.origin | append: variant.url | json }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }
    </script>

  </div>
</section>

{% schema %}
{
  "name": "t:sections.main-product.name",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "text",
      "name": "Example text block",
      "settings": [
        {
          "type": "inline_richtext",
          "id": "text",
          "default": "Text block",
          "label": "Text"
        },
        {
          "type": "select",
          "id": "text_style",
          "options": [
            { "value": "body", "label": "Body" },
            { "value": "subtitle", "label": "Subtitle" },
            { "value": "uppercase", "label": "Uppercase" }
          ],
          "default": "body",
          "label": "Text style"
        }
      ]
    },
    {
      "type": "title",
      "name": "Product title",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Product price",
      "limit": 1
    },
    {
      "type": "sku",
      "name": "Product SKU",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "text_style",
          "options": [
            { "value": "body", "label": "Body" },
            { "value": "subtitle", "label": "Subtitle" },
            { "value": "uppercase", "label": "Uppercase" }
          ],
          "default": "body",
          "label": "SKU text style"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_sticky_info",
      "default": true,
      "label": "Enable Sticky Product Info"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "background-1",
      "label": "Color scheme"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    }
  ]
}
{% endschema %}

{# 
  ------------------------------------------------------------------------
  BELOW is the JobRad leasing calculator snippet (only in German).
  Place it outside the schema so the JSON remains valid.
  ------------------------------------------------------------------------
#}

{% if localization.language.iso_code == 'de' %}
<div class="leasingratenrechner" style="padding: 1em; border: 1px solid #ccc; margin-top: 1em;">
  <h2 style="margin-top: 0;">Leasingratenrechner</h2>
  <p>
    Welches Leasingmodell passt am besten zu Ihnen? Einfach den Bruttokaufpreis 
    Ihres Wunschrads eingeben und die drei Optionen vergleichen!
  </p>

  <!-- Price Input -->
  <div style="margin-bottom: 1em;">
    <label for="bikePrice" style="display:block; margin-bottom:0.3em;">
      Bruttokaufpreis Ihres Wunschrads inkl. Zubehör (EUR):
    </label>
    <input 
      type="number" 
      id="bikePrice" 
      value="1259.66" 
      step="0.01" 
      style="width: 100%; max-width:300px; padding:0.5em;"
    />
  </div>

  <!-- Calculate Button -->
  <button 
    type="button" 
    onclick="calculateJobRadLeasing()" 
    style="display: inline-block; background: #333; color: #fff; padding: 0.6em 1em; border: none; cursor: pointer;"
  >
    Jetzt berechnen
  </button>

  <p style="margin-top:0.5em; font-size:0.9em; color:#555;">
    Alle Werte werden als Nettopreise (ohne MwSt.) dargestellt, da JobRad®-Leasing
    auf Netto-Basis erfolgt. Wir rechnen hier pauschal mit 19% MwSt.
  </p>

  <hr style="margin:1em 0;">

  <!-- Model 1: 20% Restwert -->
  <div id="model1" style="border: 1px solid #aaa; padding: 1em; margin-top: 1em; display:none;">
    <h4 style="margin-top: 0;">Monatlich am günstigsten fahren</h4>
    <p style="margin: 0.5em 0;">
      Der Restwert zum Leasingende ist etwas höher (20&nbsp;% vom Nettopreis) – dadurch werden die monatlichen Leasingraten geringer.
    </p>
    <p style="font-size: 1.2em; font-weight: bold; margin: 0.5em 0;">
      <span id="model1Monthly"></span> €<br>
      <span style="font-size: 0.9em; font-weight: normal;">monatlich</span>
    </p>
    <p style="margin: 0.5em 0 0;">
      <strong id="model1Residual"></strong> €<br>
      <span style="font-size: 0.9em;">einmalig Restwert</span>
    </p>
    <hr>
    <p style="margin: 0.5em 0;">
      <strong>Im Detail:</strong><br>
      <span id="model1LeaseRate"></span> € monatliche Leasingrate + 
      <span id="model1Insurance"></span> € JobRad®-Vollkaskoversicherung<br>
      <strong id="model1ResidualDetail"></strong> € (20&nbsp;% vom Netto-Kaufpreis)
    </p>
    <p style="font-size: 0.8em; color: #555; margin-top: 0.5em;">
      Laufzeit: 36 Monate. Alle Preise sind Nettopreise (zzgl. MwSt.).
    </p>
  </div>

  <!-- Model 2: 15% Restwert -->
  <div id="model2" style="border: 1px solid #aaa; padding: 1em; margin-top: 1em; display:none;">
    <h4 style="margin-top: 0;">Alle Kosten fürs Leasing im Gleichgewicht</h4>
    <p style="margin: 0.5em 0;">
      Etwas höhere Raten als Modell 1, dafür ein geringerer Restwert von 15&nbsp;% am Ende.
    </p>
    <p style="font-size: 1.2em; font-weight: bold; margin: 0.5em 0;">
      <span id="model2Monthly"></span> €<br>
      <span style="font-size: 0.9em; font-weight: normal;">monatlich</span>
    </p>
    <p style="margin: 0.5em 0 0;">
      <strong id="model2Residual"></strong> €<br>
      <span style="font-size: 0.9em;">einmalig Restwert</span>
    </p>
    <hr>
    <p style="margin: 0.5em 0;">
      <strong>Im Detail:</strong><br>
      <span id="model2LeaseRate"></span> € monatliche Leasingrate + 
      <span id="model2Insurance"></span> € JobRad®-Vollkaskoversicherung<br>
      <strong id="model2ResidualDetail"></strong> € (15&nbsp;% vom Netto-Kaufpreis)
    </p>
    <p style="font-size: 0.8em; color: #555; margin-top: 0.5em;">
      Laufzeit: 36 Monate. Alle Preise sind Nettopreise (zzgl. MwSt.).
    </p>
  </div>

  <!-- Model 3: 10% Restwert -->
  <div id="model3" style="border: 1px solid #aaa; padding: 1em; margin-top: 1em; display:none;">
    <h4 style="margin-top: 0;">Zum Leasingende am günstigsten aufsteigen</h4>
    <p style="margin: 0.5em 0;">
      Höhere Raten zahlen – und am Ende der Laufzeit von nur 10&nbsp;% Restwert profitieren.
    </p>
    <p style="font-size: 1.2em; font-weight: bold; margin: 0.5em 0;">
      <span id="model3Monthly"></span> €<br>
      <span style="font-size: 0.9em; font-weight: normal;">monatlich</span>
    </p>
    <p style="margin: 0.5em 0 0;">
      <strong id="model3Residual"></strong> €<br>
      <span style="font-size: 0.9em;">einmalig Restwert</span>
    </p>
    <hr>
    <p style="margin: 0.5em 0;">
      <strong>Im Detail:</strong><br>
      <span id="model3LeaseRate"></span> € monatliche Leasingrate + 
      <span id="model3Insurance"></span> € JobRad®-Vollkaskoversicherung<br>
      <strong id="model3ResidualDetail"></strong> € (10&nbsp;% vom Netto-Kaufpreis)
    </p>
    <p style="font-size: 0.8em; color: #555; margin-top: 0.5em;">
      Laufzeit: 36 Monate. Alle Preise sind Nettopreise (zzgl. MwSt.).
    </p>
  </div>
</div>

<script>
function calculateJobRadLeasing() {
  const bruttoStr = document.getElementById('bikePrice').value;
  const brutto = parseFloat(bruttoStr) || 0;

  const netPrice = brutto / 1.19; // 19% MwSt
  const insurance = 4.41;        // Netto pro Monat
  const term = 36;

  const models = [
    { id: 'model1', residualPercent: 0.20 },
    { id: 'model2', residualPercent: 0.15 },
    { id: 'model3', residualPercent: 0.10 }
  ];

  models.forEach(m => {
    document.getElementById(m.id).style.display = 'block';

    const residual = netPrice * m.residualPercent;
    const financeAmt = netPrice - residual;
    const monthlyLease = financeAmt / term;
    const totalMonthly = monthlyLease + insurance;

    document.getElementById(m.id + 'Monthly').textContent       = totalMonthly.toFixed(2);
    document.getElementById(m.id + 'Residual').textContent      = residual.toFixed(2);
    document.getElementById(m.id + 'LeaseRate').textContent     = monthlyLease.toFixed(2);
    document.getElementById(m.id + 'Insurance').textContent     = insurance.toFixed(2);
    document.getElementById(m.id + 'ResidualDetail').textContent= residual.toFixed(2);
  });
}
</script>
{% endif %}
